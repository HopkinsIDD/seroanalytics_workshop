---
title: "Lab 1 file"
output: html_document
date: "2025-04-28"
---

We need to have multiple types of data for analysis. 
We'll start by going through the different types of data you will want to have

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The raw CSV file from multiplex contains a number of different types of data that you will need
This raw data will contain data from one plate (generally 96 wells). It will have wells of samples, controls, standard curves (sometimes), and blanks.
We will go over one of these raw sheets. Here we can find the raw assay results and the experiment meta-data. Your raw data may look slightly different based on the machine.
For all of the antigens: 
-Information about the machine, including when it was last calibrated and validated
-Raw MFI values
-Number of beads
-Sample dilution (especially important for standard curves)
-Any error messages

```{r readIn}

#label R chunks so that we can easily find them if something goes wrong in the knitting 

##change all file paths to be ~/seroanalytics_workshop/.... we will instruct participants on day 1 to set their WD to that folder so that "~" represents their local path. 
  file_name <- "/Users/sarahlapidus/Documents/Malawi training docs/Data sets/Raw Plate 1 dataset.csv"
  raw_dat <- read.csv(file_name)
  class(raw_dat)


```


Sections of raw:
Top part of df is  information about the machine. It is important to check that the machine was working correctly, and passed the validation and calibration checks on the machine. Check the dates of the calibration and validation to make sure it was done before the assay was run.

```{r}
  View(raw_dat[c(1:36),])
```

The next part of the raw data indicates DataType: Median. These are the raw MFI values
See how these are split for each antigen
We have seperate rows for each well of the plate, including samples, controls, standard curves, and blanks
Here, our positive controls (POS1 and POS2) are pooled positive controls (expected to be positive to all pathogen antigens). The negative controls (NEG1 and NEG2) are from people from a non-endemic area, and are expected to be negative for all antigens.
Blanks (BLANK1 and BLANK2) don't include any serum/DBS, and can show how much reactivity there is just do to the machine.
We can have responses to a control bead as well. In this dataset, SNAP is a control, and we'll talk about what that means this afternoon.

```{r}
  View(raw_dat[c(38:137),])
```


The next part is DataType:Net MFI
This is calculated as the MFI for each antigen - mean(Blank wells). The is the default way to adjust for the background, but there are other ways as well that we'll discuss this afternoon. 
```{r}
  View(raw_dat[c(139:236),])
```

The next part is DataType:Count
This is the number of beads counted for each antigen
If there are too few beads measured for an antigen, then that data could be unreliable. 
This machine was set to aim to measure at least 50 beads for each antigen, but will sometimes measure less than that.
We can use this data to check that a minimum number of beads were measured for each antigen (eg 30 or 50 beads), and exclude results if too few beads were measured.

```{r}
  View(raw_dat[c(238:335),])
```

The next part is Avg Net MFI. If samples were tested in duplicate, this would give average Net MFI (background subtracted MFI) of the duplicates

```{r}
  View(raw_dat[c(337:432),])
```


The next two sections show the regions for the different antigens, and the number of beads that the machine is set to measure.
```{r}
  View(raw_dat[c(434:442),])
```

The next section is the dilution factor. This likely will be the same for all of the samples. It is important information for the standard curves, which we will use to convert MFI values to other units, like concentration of the antibody. Note that standard curves will be for a specific antigen.

```{r}
  View(raw_dat[c(444:542),])
```


The last sections show whether there were specific types of analysis that the machine already ran (my preference is to use raw results from a machine and do the analysis seperately), audit logs, and warning messages. These warning messages show wells where the bead count was <50 for alteast one antigen.
```{r}
  View(raw_dat[c(544:567),])
```


In addition to the raw sample data, you will likely have additional data about the samples. In this training dataset, we can sex and age. This could also include variables like cluster and cluster weights.

We also need to have an indicator variable to be able to match the data from the machines with other information about the samples

```{r}
#see above for file paths 
  file_name <- "/Users/sarahlapidus/Documents/Malawi training docs/Data sets/Training demographics df.csv"
  demographics_dat <- read.csv(file_name)
  class(demographics_dat)
  View(demographics_dat)


```

We also need information on the controls. Ideally, we'll have positive and negative controls for all our antigens, but there is sometimes analysis we can do with only negative controls, or without controls (we'll discuss this tomorrow).

Here, our positive controls are pooled positive controls (expected to be positive to all pathogen antigens). You may have positive controls that are specific for certain antigens.
The negative controls are from people from a non-endemic area, and are expected to be negative for all antigens. This also may be different for your controls.
We also have standard curves for certain antigens

```{r}

#see above for file paths 
  file_name <- "/Users/sarahlapidus/Documents/Malawi training docs/Data sets/simulated_control_long_training_data.csv"
  control_dat <- read.csv(file_name)
  class(control_dat)
```

We can look at our data of positive and negative controls by antigen, and make a table showing the numbers of these
First we will subset the dataframe to select just the positive and negative controls, and then look at that data, and make a table.

```{r}
pos_neg_controls <- control_dat[control_dat$vpd_dilution_series=="no",]

View(pos_neg_controls[,c(1,2,3)])
table(pos_neg_controls$antigen, pos_neg_controls$pos_neg)
```

For standard curves, we get additional information including the dilution
```{r}
View(control_dat[control_dat$vpd_dilution_series=="yes",c(1,2,3,4,7)])
```


Other additional data you should have (that may or may not be in a dataset include:
  Specimen information (DBS, plasma)
  Manual flag for sample quality

The Source file includes a function that can read in and tidy the raw data (read_and_tidy function). 
```{r run_read_and_tidy}
#see above for file paths 
#move this to the top of the document where you call your libraries etc. 
source("/Users/sarahlapidus/Documents/Malawi training docs/Source file V1.R")

#this part here needs to be re copied in lab 2 so that lab 2 can stand alone 
  file_name <- "/Users/sarahlapidus/Documents/Malawi training docs/Data sets/Raw Plate 1 dataset.csv"
  plate_number <- "1"
  num_wells <- 96
  antigen_names <- c("SNAP",	"WNV",	"YF",	"JE3",	"ZIKA",	"DENV",	"CHIKV",	"GLURPR2",	"CSP",	"PfAMA1",	"PfMSP119",	"WRUV",	"WMEV")
  control_samples <- c("POS1", "POS2", "NEG1", "NEG2")
  background_samples <- c("BLANK1", "BLANK2")
  
  standard_curve_values= data.frame(Sample= c("Std Curve wruv 1:80", "Std Curve wruv 1:40", "Std Curve wruv 1:20", "Std Curve wruv 1:10",
                             "Std Curve wruv 1:5", "Std Curve wruv 1:2.5", "Std Curve wruv 1:1.25", "Std Curve wruv 1:0.625"),
                                  Dilution= c(1/100, 1/200, 1/400, 1/800, 1/1600, 1/3200, 1/6400, 1/12800),
                              Location= c("89(1,A12)", "90(1,B12)", "91(1,C12)", "92(1,D12)", "93(1,E12)", "94(1,F12)", "95(1,G12)", "96(1,H12))"),
                              Replicate= paste("wruv", 1:8))
  bead_threshold <- 30 #this is the minimum number of beads we want to have in our data
    
  plate_1_tidy<- read_and_tidy(file_name, plate_number, num_wells, antigen_names, control_samples, background_samples, standard_curve_values, bead_threshold)
  
  head(plate_1_tidy)
  class(plate_1_tidy)
  
```

This results in a long dataset with results of one antigen per row. It also includes bead counts and plate numbers
```{r}
View(plate_1_tidy)
```


We will repeat this with Plate 2 raw data.
```{r}

#don't re-call the source when you've already done
source("/Users/sarahlapidus/Documents/Malawi training docs/Source file V1.R")

#don't relabel things that have already been labeled, just write directly for things like plate number or file in the function (e.g. file_name =="xxx.csv", plate_number="2")
#for things like antigen names if they are not changing from plate-to-plate don't rename them 
  file_name <- "/Users/sarahlapidus/Documents/Malawi training docs/Data sets/Raw Plate 2 dataset.csv"
  plate_number <- "2"
  num_wells <- 96
  antigen_names <- c("SNAP",	"WNV",	"YF",	"JE3",	"ZIKA",	"DENV",	"CHIKV",	"GLURPR2",	"CSP",	"PfAMA1",	"PfMSP119",	"WRUV",	"WMEV")
  control_samples <- c("POS1", "POS2", "NEG1", "NEG2")
  background_samples <- c("BLANK1", "BLANK2")
  
  standard_curve_values= data.frame(Sample= c("Std Curve wruv 1:80", "Std Curve wruv 1:40", "Std Curve wruv 1:20", "Std Curve wruv 1:10",
                             "Std Curve wruv 1:5", "Std Curve wruv 1:2.5", "Std Curve wruv 1:1.25", "Std Curve wruv 1:0.625"),
                                  Dilution= c(1/100, 1/200, 1/400, 1/800, 1/1600, 1/3200, 1/6400, 1/12800),
                              Location= c("89(1,A12)", "90(1,B12)", "91(1,C12)", "92(1,D12)", "93(1,E12)", "94(1,F12)", "95(1,G12)", "96(1,H12))"),
                              Replicate= paste("wruv", 1:8))
  bead_threshold <- 30 #this is the minimum number of beads we want to have in our data
    
  plate_2_tidy<- read_and_tidy(file_name, plate_number, num_wells, antigen_names, control_samples, background_samples, standard_curve_values, bead_threshold)
  
  head(plate_2_tidy)
  class(plate_2_tidy)

```

Last, we can look at the plate 2 data

```{r}
View(plate_2_tidy)

```





Lab questions:

1. For the following pieces of information, check where you have each piece of information (ie which dataset), or whether there is information you're missing. You may have information that is missing, or information that just wasn't collected or may not be applicable. If you have additional information (variables like latitude/longitude, species (ie if non-human) etc.) if available as well.

Sample meta-data
  Unique sample ID
  Sample date
  Specimen information (DBS, plasma)
  Manual flag for sample quality
  Demographics: age, sex, location, vacc status
  Survey indicators: sample weight
  Manual flag for whether the sample is included in the data analysis
  
Experiment meta-data
  Plate ID
  Date run
  Sample ID
  Well ID
  MFI (by antigen)
  Net MFI (by antigen)
  Bead count (by antigen)

Control meta-data
  Unique control ID
  Positive or negative control
  Control for which antigen
  Source/description of control (e.g., “US non-traveler who’s never had Pf malaria”)
  Dilution, if part of a standard curve (e.g., “Positive Pool 1:50”)
  Short description of what the control is (e.g., “NIBSC XX international standard”)

2. Is there any data that you're missing that may limit the analysis you're able to do?

3. Make a list of the antigens you're using in your analysis. 

4. Adjust the code below to read your datasets into R and look at the tops of the datasets

```{r}
#what is the intention of this exercise, how is it different than what we previously did in the lab? 

  #sample data
  raw_dat_plate1 <- "Plate1 raw dataset.csv" #Adjust these file names to match your dataset names
  head(raw_dat_plate1)
  raw_dat_plate2 <- "Plate2 raw dataset.csv" #Adjust these file names to match your dataset names
  head(raw_dat_plate2)
  #add more lines to read in additional plates
  
  #Control data
  control_dat <- "Control dataset.csv" #Adjust these file names to match your dataset names
  head(control_dat)
  
  #Any other data
  demographic_dat <- "Demographic dataset.csv" #Adjust these file names to match your dataset names
  head(demographic_dat)

```

5. Take a look at your raw datasets. Is the format similar or different to the raw data set we went through earlier? In what ways is it similar and different? 

```{r}
View(raw_dat_plate1)
View(raw_dat_plate2)
```


5. Make a table showing the controls you have by antigen (split by positive and negative controls.)
Make sure this dataset just includes positive and negatives controls. Adjust the following code depending on the column names in your dataset.
```{r}
table(control_dat$antigen, control_dat$pos_neg)
```

6. Do you have standard curves in your data? Are they are on the same or different plates than your samples?
List the antigens the you have standard curves for. How many points are on these curves, and what dilutions are they?

Write code to show this data from your data sets. This code will differ depending on what datasets this information is in.

7. Apply the read and tidy function to your datasets.
If you're data sets are already cleaned, or are not in a raw MBA format, use the raw Plate 3 and Plate 4 training data.

8. Adjust the following code 

Make sure you set the correct working directory (folder that you have your data stored in)
```{r}
#same comment as above, how is this different than what was done before? 

  file_name <-  "Plate1 raw dataset.csv" #Adjust name
  plate_number <- "1" #Adjust plate number
  num_wells <- 96  #Adjust number of wells 
  antigen_names <- c("SNAP",	"WNV",	"YF",	"JE3",	"ZIKA",	"DENV",	"CHIKV",	"GLURPR2",	"CSP",	"PfAMA1",	"PfMSP119",	"WRUV",	"WMEV") #adjust antigen names
  control_samples <- c("POS1", "POS2", "NEG1", "NEG2") #adjust control names
  background_samples <- c("BLANK1", "BLANK2") #adjust names and number of blank samples
  
  #Adjust standard curve information. Based on your data
  standard_curve_values= data.frame(Sample= c("Std Curve wruv 1:80", "Std Curve wruv 1:40", "Std Curve wruv 1:20", "Std Curve wruv 1:10",
                             "Std Curve wruv 1:5", "Std Curve wruv 1:2.5", "Std Curve wruv 1:1.25", "Std Curve wruv 1:0.625"),
                                  Dilution= c(1/100, 1/200, 1/400, 1/800, 1/1600, 1/3200, 1/6400, 1/12800),
                              Location= c("89(1,A12)", "90(1,B12)", "91(1,C12)", "92(1,D12)", "93(1,E12)", "94(1,F12)", "95(1,G12)", "96(1,H12))"),
                              Replicate= paste("wruv", 1:8))
  bead_threshold <- 30 #you can adjust this. this is the minimum number of beads we want to have in our data
    
  plate_tidy<- read_and_tidy(file_name, plate_number, num_wells, antigen_names, control_samples, background_samples, standard_curve_values, bead_threshold)
  
```

9. Look at this dataframe to ensure the function worked as you expected. Save this data frame. 

```{r}
#why are we setting the working directory now, why are we writing a csv file at this stage? 
  View(plate_tidy)
  setwd("working_directory_location") #you can adjust this to save file in a different folder
  write.csv(plate_tidy, "Plate_tidy.csv", row.names = FALSE) #Adjust this to give file a different name (eg. Plate1, Plate2 tidy)

```

10. Redo steps 8 and 9 for any other raw plates you have.

```{r}
#same question as above
  file_name <-  "Plate1 raw dataset.csv" #Adjust name
  plate_number <- "1" #Adjust plate number
  num_wells <- 96  #Adjust number of wells 
  antigen_names <- c("SNAP",	"WNV",	"YF",	"JE3",	"ZIKA",	"DENV",	"CHIKV",	"GLURPR2",	"CSP",	"PfAMA1",	"PfMSP119",	"WRUV",	"WMEV") #adjust antigen names
  control_samples <- c("POS1", "POS2", "NEG1", "NEG2") #adjust control names
  background_samples <- c("BLANK1", "BLANK2") #adjust names and number of blank samples
  
  #Adjust standard curve information. Based on your data
  standard_curve_values= data.frame(Sample= c("Std Curve wruv 1:80", "Std Curve wruv 1:40", "Std Curve wruv 1:20", "Std Curve wruv 1:10",
                             "Std Curve wruv 1:5", "Std Curve wruv 1:2.5", "Std Curve wruv 1:1.25", "Std Curve wruv 1:0.625"),
                                  Dilution= c(1/100, 1/200, 1/400, 1/800, 1/1600, 1/3200, 1/6400, 1/12800),
                              Location= c("89(1,A12)", "90(1,B12)", "91(1,C12)", "92(1,D12)", "93(1,E12)", "94(1,F12)", "95(1,G12)", "96(1,H12))"),
                              Replicate= paste("wruv", 1:8))
  bead_threshold <- 30 #you can adjust this. this is the minimum number of beads we want to have in our data
    
  plate_tidy<- read_and_tidy(file_name, plate_number, num_wells, antigen_names, control_samples, background_samples, standard_curve_values, bead_threshold)
  
```

```{r}
#same question as above 
  View(plate_tidy)
  setwd("working_directory_location") #you can adjust this to save file in a different folder
  write.csv(plate_tidy, "Plate_tidy.csv", row.names = FALSE) #Adjust this to give file a different name (eg. Plate1, Plate2 tidy)

```
