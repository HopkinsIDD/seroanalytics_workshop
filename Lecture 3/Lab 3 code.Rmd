---
title: "Lab 3 code"
output: html_document
date: "2025-05-22"
---

Lab 3 objectives: Visualize data and calculate and interpret seropositivity based on a cutoff

Go through the following file to complete Lab 3. 

Note: Trainees should use the data from their own experiment when possible. If methods are not possible (ie because of the lack of controls or standard curve etc), then trainees should use the extra data set available. Do the following for one of your antigens. If time, repeat for additional antigens.

First run the following set up code. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r source_and_working_directory}
source("~/seroanalytics_workshop/Source file V1.R")
```


Read in your data. Use the extra data set for any questions you're not able to answer with your own data.
Edit the code below to read in your data

```{r reading_in_data}

standards_data <- read.csv("data/simulated_standard_curve_training_data.csv")
control_data <- read.csv("data/simulated_control_long_training_data.csv")
sample_data <- read.csv("data/simulated_sample_wide_training_data.csv")

#this converts sample_data from a wide to a long dataframe. edit the column names to your data.
sample_long <- reshape(
  sample_data,
  varying = setdiff(names(sample_data), c("id", "age", "sex")),
  v.names = "mfi",
  timevar = "antigen",
  times = setdiff(names(sample_data), c("id", "age", "sex")),
  idvar = "id",
  direction = "long"
)
rownames(sample_long) <- NULL


```

1. Adjust the code below to make a histogram of sample MFI values in an untransformed and log scale. 
  a. Consider how many bins to use (edit bins = 30 to see what data looks like with different numbers of bins). 
  b. Describe the distribution (untransformed and log scale). 
  c. Are there any outliers or anything unusual about your data?
  
```{r sample_untransformed_scale}

#natural scale
faceted_natural_scale <- ggplot(sample_long, aes(x = mfi)) +
  geom_histogram(bins = 30, color = "black", fill = "blue") +
  facet_wrap(~ antigen, scales = "free", ncol = 5) +  # <- Set 5 columns per row
  labs(
    title = "Put your title here",
    x = "Antigen MFI",
    y = "Number of samples"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 10),  # Smaller font for facet labels
    axis.text = element_text(size = 10),  # Smaller font for axis text
    plot.title = element_text(size = 10)  # Smaller font for the plot title
  )
faceted_natural_scale

```

```{r sample_log_scale}

#log scale
faceted_log_scale <- ggplot(sample_long, aes(x = log(mfi))) +
  geom_histogram(bins = 30, color = "black", fill = "blue") +
  facet_wrap(~ antigen, scales = "free", ncol = 5) +  # <- Set 5 columns per row
  labs(
    title = "Put your title here",
    x = "Log Antigen MFI",
    y = "Number of samples"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 10),  # Smaller font for facet labels
    axis.text = element_text(size = 10),  # Smaller font for axis text
    plot.title = element_text(size = 10)  # Smaller font for the plot title
  )
faceted_log_scale

```

  
2. Make a histogram of control MFI values. Color the histogram by positive and negative controls. Is there overlap between your positive and negative controls?

```{r untransformed_controls_histogram}

    neg_controls_natural_scale <- ggplot(control_data, aes(x = log(mfi), fill = pos_neg)) +
      geom_histogram(bins = 20, color = "black") +
      facet_wrap(~ antigen, scales = "free", ncol = 4) +
      labs(
        title = "Sample Distribution (Natural Scale)",
        x = "Antigen MFI",
        y = "Number of samples"
      ) +
      theme_minimal() +
      theme(
        strip.text = element_text(size = 10), 
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 10) 
      )
    neg_controls_natural_scale
```

```{r log_controls_histogram}

    neg_controls_log_scale <- ggplot(control_data, aes(x = log(mfi), fill = pos_neg)) +
      geom_histogram(bins = 20, color = "black") +
      facet_wrap(~ antigen, scales = "free", ncol = 4) +  # <- Set 5 columns per row
      labs(
        title = "Sample Distribution (Log Scale)",
        x = "Log Antigen MFI",
        y = "Number of samples"
      ) +
      theme_minimal() +
      theme(
        strip.text = element_text(size = 10),  # Smaller font for facet labels
        axis.text = element_text(size = 10),  # Smaller font for axis text
        plot.title = element_text(size = 10)  # Smaller font for the plot title
      )
    neg_controls_log_scale

```


3. What is the source of your controls? How would using these controls to establish a cutoff affect your interpretation of seroprevalence for this antigen?

  If you're using the training data set, you can find information about controls in the file: Information about datasets.docx


4. For an antigen with an established standard cutoff (eg. based on a correlate of protection):
If you are using the training data set, you can use the antigen wmev (Measles antigen). For wmev, the cutoff value of 153 mIU/mL is equivalent to an MFI of 156.94 based on a standard curve. 
If you are using your own data, look up the appropriate cutoff to use.

  a. For this antigen, remake the histogram showing sample MFI values and add a vertical line showing the cutoff. Do this on an untransformed and a log scale.
  
```{r untransformed_scale}

#natural scale
faceted_natural_scale <- ggplot(sample_data, aes(x = WMEV)) +
  geom_histogram(bins = 30, color = "black", fill = "blue") +
  geom_vline(xintercept = cutoff, linetype = "dashed", color = "red", size = 0.8) +  # Add vertical dashed line at the cutoff
  labs(
    title = "Put your title here",
    x = "Antigen MFI",
    y = "Number of samples"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 10),  # Smaller font for facet labels
    axis.text = element_text(size = 10),  # Smaller font for axis text
    plot.title = element_text(size = 10)  # Smaller font for the plot title
  )
faceted_natural_scale

```
  
```{r log_scale}
#log scale
faceted_log_scale <- ggplot(sample_data, aes(x = log(WMEV))) +
  geom_histogram(bins = 30, color = "black", fill = "blue") +
  geom_vline(xintercept = log(cutoff), linetype = "dashed", color = "red", size = 0.8) +  # Add vertical dashed line at the cutoff
  labs(
    title = "Put your title here",
    x = "Log Antigen MFI",
    y = "Number of samples"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 10), 
    axis.text = element_text(size = 10),  
    plot.title = element_text(size = 10) 
  )
faceted_log_scale
```  
  
   b. Apply cutoff. How many people are seropositive according to this cutoff, and what percent of people are seropositive?
  
```{r applying_cutoff}

#Setting cutoff:
cutoff <- 156.94 #replace with your cutoff based on the standard curve

#Applying cutoff:
  #ifelse function, if first statement is true, then outcome is set to 1, and if first statemnet is false, then outcome is 0
  #since the first statement is a vector, then outcome will be a vector of 1's and 0's.
seropositivity <- ifelse(sample_data$WMEV > cutoff, 1, 0) #1 indicates seropositive, and 0 indicates seronegative

#number of people seropositve and seronegative  
cat("Table of number seronegative and seronegative", "\n")
table(seropositivity,useNA="always")  
  
#percent of people seropositive and negative
cat("Table of percent seronegative and seronegative", "\n")
round(prop.table(table(seropositivity,useNA="always")),3)*100

```
  
  c. Calculate the confidence interval for this seroprevalence
  
```{r seroprevalence_confidence_interval}
  # Set your parameters
  x <- 767 #number seropositive. Get the number seropositive in your sample from the seropositive table above
  n <- nrow(sample_data) #total number of samples in your data
  conf <- 0.95 #confidence interval. 95% is a standard CI but you can adjust this if you want
  
  # Exact interval
  ci <- binom.exact(x, n, conf.level = conf) #epitools function
  #
  cat("CI lower", round(ci$lower,4)*100, "%, CI upper", round(ci$upper,4)*100, "%")
```
  
  d. For this specific antigen, how would you interpret this seropositivity and confidence interval? 
  
  e. What do you think about using this cutoff method for this antigen? What are the assumptions that went into this cutoff method?

