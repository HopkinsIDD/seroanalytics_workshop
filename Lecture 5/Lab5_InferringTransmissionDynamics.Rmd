---
title: "Lab5: Inferring Transmission Dynamics from serological data"
output: html_document
date: "2025-04-28"
---

### 1. Set up our environment

```{r setup}
# clear everything in the environment
rm(list=ls()) 

# load packages
library(ggplot2)
library(epitools)

```

### 2. Read in our data

You will need to change the "path" variable to the location of the files on your computer.

```{r read in data}
# set file path and read in the data
path <- "C:/Users/megan/Documents/GitHub/seroanalytics_workshop/Lecture5" 
df <- read.csv(paste(path, "simulated_data.csv", sep="/"))

# lets take a look at our dataset
# in this lab we will focus on the dengue (DENV) and chikungunya (CHIKV) data
head(df)
```

### 3. Calculate age-specific seroprevalence

Here, we want to calculate age-specific seroprevalence, based on the individual-level serostatus determined in the previous tutorials.

Its important to check the age-distribution of the study population before deciding what age groups to use for analysis. This is to ensure that we choose age groups with a sufficient number of people.

```{r seroprevalence, echo=FALSE}


# lets first check the age distribution of the study population
hist(df$age) 

# because we have more young people, we will use 5-year age bins for people <20, then switch to 10-year groups before aggregating everyone above the age of 80years due to their smaller sample size

# we will now assign everyone to their age group
age_groups <- c("0-4","5-9","10-14","15-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")
df$age_group <- cut(df$age, c(-Inf,4,9,14,19,29,39,49,59,69,79,Inf), labels=age_groups)

# lets check how many people we have in each age group
table(df$age_group)

# now that we have assigned age groups we can calculate the seroprevalence in each group

# create a list to store the seroprevalence data
seroprev <- list()

# we now loop through each pathogen of interest
for(p in c("CHIKV","DENV")){ 
  
  # create a dataframe and store it in the list
  seroprev[[p]] <- data.frame(age_group=factor(age_groups, levels=age_groups), n=NA, npos=NA)
  
  # loop through each age group
  for(a in 1:length(age_groups)){ 
    seroprev[[p]]$n[a] <- nrow(df[df$age_group==age_groups[a], ]) # how many people in this age group
    seroprev[[p]]$npos[a] <- nrow(df[df$age_group==age_groups[a] & df[,p]==1, ]) # how many positive in this age group
  }
  
  # we can now calculate seroprevalence (npos/n)
  seroprev[[p]]$prev <- seroprev[[p]]$npos/seroprev[[p]]$n
  
  # and get binomial confidence intervals
  seroprev[[p]][,c("ciL","ciU")] <- binom.exact(seroprev[[p]]$npos, seroprev[[p]]$n)[,c("lower","upper")]
  
}
```

### 4. Investigate transmission dynamics

We will now plot the age-specific seroprevalence data and answer the questions below:

-   Question 1: What do we think has happened with CHIKV transmission here?

-   Question 2: What kind of transmission pattern do we see for DENV?

```{r transmission}


# plot age-specific CHIKV seroprevalence
ggplot(seroprev$CHIKV, aes(age_group, prev))+ geom_point()+ ggtitle("Chikungunya")+ 
  geom_linerange(aes(ymin=ciL, ymax=ciU))+ ylab("Seroprevalence")+ xlab("Age group")


# plot age-specific DENV seroprevalence
ggplot(seroprev$DENV, aes(age_group, prev))+ geom_point()+ ggtitle("Dengue")+ ylim(0,1)+
  geom_linerange(aes(ymin=ciL, ymax=ciU))+ ylab("Seroprevalence")+ xlab("Age group")


```

### 5. Estimating FOI (force of infection)

We will now fit a catalytic model to the age-specific DENV seroprevalence data to estimate force of infection (FOI). We will do this using a generalized linear model (GLM) with a complementary log-log link. In this model we assume:

-   that FOI is constant over time (i.e. the result can be interpreted as the long-term average annual FOI)

-   that FOI does not vary with age (i.e. age does not impact the risk of infection)

```{r FOI}

# for this model we will use the mid-points of each age group 
age_mid <- c(2, 7, 12, 17, 24.5, 34.5, 44.5, 54.5, 64.5, 74.5, 90)
seroprev$DENV$age_mid <- age_mid

# fit catalytic model
mod <- glm(cbind(npos, n-npos) ~ 1, offset=log(age_mid), 
           data=seroprev$DENV, family = binomial(link = "cloglog"))

# model results
summary(mod)

# the model provides an estimate of the log of the FOI, requiring us to exponentiate the result
log_FOI <- mod$coefficients[1]
FOI <- exp(log_FOI)

# the model estimates a 6.6% force of infection


# lets calculate the confidence intervals around this estimate
se_log_FOI <- summary(mod)$coefficients[1,2]
ci_log_FOI <- log_FOI + c(-1.96, 1.96) * se_log_FOI
ci_FOI <- exp(ci_log_FOI)


# lets now see how well this estimate fits our data

# calculate predicted seroprevalence by age group
pred_seroprev <- data.frame(age_group=seroprev$DENV$age_group,
                            pred=1-exp(-FOI*age_mid), 
                            ciL=1-exp(-ci_FOI[1]*age_mid),
                            ciU=1-exp(-ci_FOI[2]*age_mid))


# plot observed vs model estimated seroprevalence
ggplot(seroprev$DENV, aes(age_group, prev))+ geom_point()+ ggtitle("Dengue")+ ylim(0,1)+
  geom_linerange(aes(ymin=ciL, ymax=ciU))+ ylab("Seroprevalence")+ xlab("Age group")+
  geom_line(data=pred_seroprev, aes(age_group, pred, group=1), col="blue")+
  geom_ribbon(data=pred_seroprev, aes(x=age_group, y=pred, ymin=ciL, ymax=ciU, group=1), fill="blue", alpha=0.2)


# we can see that the model estimate of FOI matches our observed data pretty well!

```

### 6. Further exploration of FOI (extra exercises if time allows)

Here we will explore what different values of FOI mean for age-specific seroprevalence and susceptibility.

-   Question: What proportion of 10 year olds would we expect to have been infected vs susceptible in each scenario?

```{r extra analyses}

# lets take some example FOI values (feel free to add your own values here)
explore_FOIs <- c(0.01, 0.05, 0.1, 0.2, 0.3)

# we will loop through each of these values and simulate expected age-specific seroprevalence values
explore_data <- list() # create a list to store the simulated data
for(i in 1:length(explore_FOIs)){
  
  edf <- data.frame(age=seq(0,90), 
                    FOI=explore_FOIs[i],
                    prev=1-exp(-explore_FOIs[i]*seq(0,90)),
                    susc=exp(-explore_FOIs[i]*seq(0,90)))
  explore_data[[i]] <- edf
  
}

# here we unlist and bind the data together for plotting
explore_data <- do.call("rbind", explore_data)

# plotting expected age-specific prevalence for different FOIs
ggplot(explore_data, aes(age, prev, col=factor(FOI)))+ geom_line()+
  ylab("Seroprevalence")+ xlab("Age (years)")+ labs(col="FOI")


# add a line at age 10 years
ggplot(explore_data, aes(age, prev, col=factor(FOI)))+ geom_line()+
  ylab("Seroprevalence")+ xlab("Age (years)")+ labs(col="FOI")+
  geom_vline(aes(xintercept=10), linetype="dashed")

# now lets also see what the proportion susceptible would look like in each scenario
ggplot(explore_data, aes(age, susc, col=factor(FOI)))+ geom_line()+
  ylab("Proportion Susceptible")+ xlab("Age (years)")+ labs(col="FOI")

```
